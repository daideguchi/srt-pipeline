# CLAUDE.md - SRTFile字幕生成プロジェクト固有メモリ

## 🎯 プロジェクト概要
**SRTFile - 高精度音声同期字幕生成システム**
- 音声ファイルから正確な日本語字幕（SRT/VTT）を自動生成
- Whisperベースの音声認識 + 台本テキストによる補正
- 実用的なセグメント長さ・CPS調整機能

## 📁 プロジェクト構造（クリーンアップ後）

### 🔧 コアファイル
- **`scripts/whisperx_subtitle_generator.py`** - 最終確定版字幕生成エンジン（V9アルゴリズム）
- **`scripts/final_whisperx_integrator_v9_duration_fix.py`** - V9開発版（同一内容）
- **`scripts/srt_utils.py`** - SRT/VTT形式ユーティリティ  
- **`scripts/srt_rules.py`** - 日本語字幕フォーマットルール

### 📊 入出力ファイル
- **`subs/final_whisperx_precision_V9_DURATION_FIXED.srt`** - 最終確定版字幕（duration保証・完璧同期）
- **`subs/final_production_direct.srt`** - 参考用従来手法
- **`subs/final_production_direct.vtt`** - 参考用VTT版
- **`models/ggml-medium.bin`** - Whisper中規模モデル（1.4GB）
- **`examples/test_job_no_capcut/`** - 作業テストケース

### 📈 解析・レポート
- **`reports/audio_peaks.json`** - 音声解析結果（無音区間検出）
- **`reports/build_system_setup_report.md`** - システム構築レポート

## ⚙️ システム仕様

### 🎵 音声処理
- **対応形式**: WAV, M4A, MP3, FLAC
- **無音検出**: -35dBアルゴリズム（220ms最小長）
- **Valley検出**: 自然な発話境界抽出

### 🤖 音声認識
- **エンジン**: Whisper medium model
- **言語**: 日本語特化
- **精度**: トークンレベルタイムスタンプ使用

### 📝 字幕生成
- **形式**: SRT, VTT両対応
- **セグメント長**: 0.8〜6.0秒
- **CPS制限**: 最大17文字/秒
- **改行ルール**: 最大2行、36文字/行

## 🔄 処理フロー

### 基本ワークフロー
1. **音声解析** → `audio_peaks.json`（無音区間検出）
2. **Whisper認識** → `whisper_medium.json`（音声→テキスト）
3. **字幕生成** → `direct_whisper_subs.py`（最適化セグメント）
4. **最終調整** → 音声長との同期確認

### 最終確定版実行（V9）
```bash
python3 scripts/whisperx_subtitle_generator.py --verbose
```

## 🚨 重要な改善履歴

### 2025-08-14: V9 Duration Fix - 最終確定版完成
**最終ゴール達成**: rapid subtitle switching完全解消・duration保証システム完成

**V8で発見された致命的問題**:
- セグメント52-53: 0.5秒duration → 字幕の高速切り替え問題
- 読み手が字幕についていけない状況発生

**V9 Duration Fix解決策**:
1. **最小duration保証**: 全セグメント2.0秒以上強制
2. **WhisperX duration検証**: 異常値（20-66秒）自動拒否
3. **Conservative overlap resolution**: duration保持優先
4. **セグメント2の5.15秒固定**: ユーザー要求完全遵守

**最終成果（V9）**:
- ✅ 総セグメント数: 89個
- ✅ Duration distribution: 83/89セグメントが2-8秒の理想範囲
- ✅ Very short segments: 0個（rapid switching完全解消）
- ✅ Overlapping segments: 0個
- ✅ セグメント2開始: 5.150秒（要求通り）
- ✅ タイムライン: 0.03s → 517.25s（完璧な517秒同期）

**確定版**: `subs/final_whisperx_precision_V9_DURATION_FIXED.srt`

### 2025-08-14: V8タイミングバグ修正完了
**目標**: セグメント統合バグ・負の時間バグの完全解決

**V7で発見された致命的バグ**:
- セグメント53: `00:05:12,530 --> 00:05:07,287` (負の5.2秒時間)
- オーバーラップ解決アルゴリズムの論理エラー

**V8修正内容**:
- オーバーラップ解決アルゴリズム完全修正
- 非現実的WhisperX時間の自動拒否（20-66秒異常セグメント）
- 元構造ベース安定アプローチによる5秒前後適切セグメント維持

**最終結果**:
- 総セグメント数: 89個（元構造完全維持）
- セグメント2開始: 5.150秒（ユーザー要求通り）
- 負の時間: 0個 ✅
- オーバーラップ: 0個 ✅
- 適切セグメント: 84/89個 (94.4%)

**最終確定版**: `subs/final_whisperx_precision_V8_TIMING_FIXED.srt`

### 2025-08-13: Whisper系統的タイミングずれ根本原因特定・解決
**根本問題**: Whisperの音声セグメンテーション精度による系統的な0.71秒遅れ

**具体的失態と分析**:
- **失態**: ユーザー「05:15」を「5秒15 = 5.15秒」と理解せず「5.00秒」に誤修正
- **根本問題**: 個別修正に終始し、系統的原因分析を怠った

**詳細分析結果**:
- Whisper認識: 「そんな日常の...」を5.860秒で開始
- 実際音声: 5.150秒で開始すべき（ユーザー確認）
- **系統的ずれ**: 0.71秒の遅れ（全セグメントで発生の可能性）

**根本原因**:
1. **Whisperセグメント境界検出精度問題**: 発話開始点を0.7秒程度遅く認識
2. **VAD (Voice Activity Detection) 調整不足**: 音声開始点の誤検出
3. **モデル固有傾向**: Whisper mediumが無音区間を過大評価する傾向

**系統的解決策実装**:
- WhisperX forced alignmentによる根本的タイミング修正
- 全89セグメントの個別精密同期
- セグメント2の5.15秒強制配置によるアンカー機能

**重要な教訓**:
- ❌ **対症療法**: ユーザーフィードバック毎の個別修正
- ✅ **根本療法**: ユーザーフィードバックから系統的問題特定→全体解決
- ⚠️ **失敗パターン**: 表面的修正で満足、根本原因分析の怠惰

### 2025-08-13: 致命的思考パターンエラー - 「代替案逃げ」の禁止
**問題行動**: リサーチでWhisperXベストプラクティス発見→インストール失敗→即座に代替案作成
**根本問題**: **技術的困難に直面した瞬間に代替案に逃げる思考癖**

**具体的失態**:
1. **リサーチ成果**: WhisperX forced alignmentが最優秀解決策と特定
2. **技術的問題**: Python 3.13環境でインストール失敗
3. **致命的判断**: 代替案「enhanced_whisper_with_vad.py」を即座作成
4. **結果**: リサーチ時間・コスト完全無駄化

**絶対禁止ルール**:
- ❌ **代替案逃げ**: 技術的困難→即座代替案作成
- ❌ **安易妥協**: ベストプラクティス放棄→劣化版実装
- ❌ **時間浪費**: リサーチ成果を実装せずに捨てる

**正しい対応**:
- ✅ **技術問題解決**: 環境構築・依存関係問題の根本解決
- ✅ **リサーチ活用**: 発見したベストプラクティスの完全実装
- ✅ **品質固執**: 妥協なく最優秀解決策を実現

### 2025-08-14: WhisperX統合システム完全成功 - 最終解決達成
**🎉 プロジェクト完了**: 音声同期字幕生成の根本問題を完全解決

**最終成果**:
1. **WhisperX強制アライメント成功**: Python 3.12環境で完全動作
2. **統合システム開発**: 理想89セグメント + WhisperX精密タイミング
3. **アライメント大幅改善**: 40%→66%成功率（64%向上）
4. **ユーザー要求完全達成**: セグメント2の5.15秒設定完璧適用
5. **品質保証**: 異常短区間解消、自然境界設定、最小1.0秒保証

**技術的革新**:
- **高精度日本語正規化**: 句読点・異字体・数字表記統一
- **柔軟アライメント**: fuzzy matching閾値調整（0.35→0.2）
- **インテリジェントフォールバック**: 失敗時比例配分・品質維持
- **文字レベル精密タイミング**: WhisperXの強制アライメント完全活用

**教訓**: 
- ✅ **ベストプラクティス堅持**: 技術困難に屈せず最優解を実現
- ✅ **系統的解決**: 個別修正でなく根本原因への包括的対応
- ✅ **品質妥協拒否**: 中途半端な代替案でなく完璧な解決策追求

### 2025-08-10: 音声同期精度問題を完全解決
**問題**: 複雑なアライメントシステムが音声タイミングを歪めていた
**解決**: Whisper直接ベースシステムに刷新
- 編集距離ベースマッピングを排除
- Whisperの認識タイムスタンプを直接使用
- セグメント長さ調整のみの最小限処理

**結果**: 
- セグメント数: 107個
- 平均CPS: 6.7（超読みやすい）
- 同期精度: Whisperネイティブ精度

### クリーンアップ完了
- 不要ファイル52個削除
- Web機能（backend/frontend）完全削除  
- 仮想環境（764MB）削除
- プロジェクトサイズ: 1.5GB→字幕生成特化

## 🎯 現在の最終確定版

### 字幕ファイル
- `subs/final_production_direct.srt` - 音声実体ベース超精密同期字幕
- `subs/final_production_direct.vtt` - 同VTT版

### 実行スクリプト
- `scripts/direct_whisper_subs.py` - 最終版字幕生成エンジン

## ⚠️ 重要な注意事項

### 削除済み・使用禁止
- ❌ `smart_subs.py` - 複雑なアライメントで音声ずれ発生（削除済み）
- ❌ `smarter_subs.py` - 編集距離ベースで問題あり（削除済み）
- ❌ `ultra_precise_subs.py` - トークン不完全マッピング（削除済み）

### 使用推奨
- ✅ `direct_whisper_subs.py` - Whisperの認識結果を直接信頼する実用的手法

## 📋 開発時のチェックリスト
- [ ] 音声ファイル形式確認（WAV推奨）
- [ ] Whisperモデル存在確認（models/ggml-medium.bin）
- [ ] 最終字幕の音声同期検証
- [ ] SRT/VTT両形式の出力確認
- [ ] CPS制限遵守確認（≤17文字/秒）

## 🎉 成果・実績
- **音声同期精度**: Whisperネイティブレベル達成
- **処理時間**: 平均4.8秒/セグメント
- **読みやすさ**: CPS 6.7（理想的）
- **ファイルサイズ**: 効率的な107セグメント構成