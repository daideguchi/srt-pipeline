# Makefile_smart - æ—¢å­˜JSONã®ã¿ã§çµ±åˆâ†’æœ€çµ‚åŒ–â†’æ¤œè¨¼
PY := python3

AUDIO  ?= audio/4_2.wav
SCRIPT ?= script_4_2.txt
CAPCUT ?= subs/0808.srt

PEAKS   ?= reports/audio_peaks.json
WHISPER ?= reports/whisper_medium.json

# TTSè£œåŠ©æ©Ÿèƒ½ï¼ˆä»»æ„ï¼‰
GENAI_VOICE ?= Puck
TTS_WAV     := audio/guide_tts.wav
WH_TTS      := reports/whisper_tts.json

OUT_TMP_SRT := subs/final_smart.srt
OUT_TMP_VTT := subs/final_smart.vtt
OUT_SRT     := subs/final_production.srt
OUT_VTT     := subs/final_production.vtt

.PHONY: prep smart finalize check smart-all tts tts-whisper smart-from-tts ci-verify auto

prep:
	@mkdir -p audio subs reports scripts

smart: $(OUT_TMP_SRT)
$(OUT_TMP_SRT): $(PEAKS) $(WHISPER) $(CAPCUT) $(SCRIPT) scripts/smart_subs.py scripts/srt_rules.py
	@test -f $(PEAKS)   || (echo "âŒ $(PEAKS) missing (æ—¢å­˜è§£æžJSONãŒå¿…è¦ã€‚å†è§£æžã¯ã—ãªã„)"; exit 1)
	@test -f $(WHISPER) || (echo "âŒ $(WHISPER) missing (æ—¢å­˜ASR JSONãŒå¿…è¦ã€‚å†è§£æžã¯ã—ãªã„)"; exit 1)
	$(PY) scripts/smart_subs.py \
	  --audio_json $(PEAKS) \
	  --whisper_json $(WHISPER) \
	  --capcut_srt $(CAPCUT) \
	  --script $(SCRIPT) \
	  --out $(OUT_TMP_SRT) \
	  --out_vtt $(OUT_TMP_VTT)

finalize: $(OUT_SRT)
$(OUT_SRT): $(OUT_TMP_SRT) scripts/finalize_tail.py
	$(PY) scripts/finalize_tail.py \
	  --in $(OUT_TMP_SRT) \
	  --audio $(AUDIO) \
	  --out $(OUT_SRT) \
	  --out_vtt $(OUT_VTT) \
	  --target_offset_ms 20

check:
	$(PY) scripts/check_durations.py --audio $(AUDIO) --srt $(OUT_SRT)

smart-all: prep smart finalize check
	@echo "ðŸŽ¯ DONE: $(OUT_SRT) / $(OUT_VTT)"

# ========================================
# TTSè£œåŠ©æ©Ÿèƒ½ - æ—¢å­˜ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¨ã¯ç‹¬ç«‹
# ========================================

tts: $(TTS_WAV)
$(TTS_WAV): $(SCRIPT) scripts/tts_synthesize.py
	@echo "ðŸŽ¤ TTSåˆæˆ: $(SCRIPT) â†’ $(TTS_WAV) (voice=$(GENAI_VOICE))"
	$(PY) scripts/tts_synthesize.py \
	  --text $(SCRIPT) \
	  --out $(TTS_WAV) \
	  --voice $(GENAI_VOICE)

tts-whisper: $(WH_TTS)
$(WH_TTS): $(TTS_WAV)
	@echo "ðŸŽ¯ TTSéŸ³å£°ã‚’Whisperã§è§£æž: $(TTS_WAV) â†’ $(WH_TTS)"
	@command -v whisper-cli >/dev/null 2>&1 || (echo "âŒ whisper-cli ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; exit 1)
	whisper-cli --model medium --language ja --output-json-full --output-file reports/whisper_tts $(TTS_WAV)

# å®Ÿé¨“ç”¨: TTSã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ä½¿ã£ãŸå­—å¹•ç”Ÿæˆï¼ˆæœ¬ç•ªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¨ã¯åˆ¥ç³»çµ±ï¼‰
smart-from-tts: $(PEAKS) $(WH_TTS) $(CAPCUT) $(SCRIPT)
	@echo "ðŸ§ª å®Ÿé¨“: TTSã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹å­—å¹•ç”Ÿæˆ"
	$(PY) scripts/smart_subs.py \
	  --audio_json $(PEAKS) \
	  --whisper_json $(WH_TTS) \
	  --capcut_srt $(CAPCUT) \
	  --script $(SCRIPT) \
	  --out subs/final_from_tts.srt \
	  --out_vtt subs/final_from_tts.vtt
	@echo "âš ï¸  æ³¨æ„: ã“ã‚Œã¯TTSç”±æ¥ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãªã®ã§æœ¬ç•ªéŸ³æºã¨åŒæœŸã—ã¾ã›ã‚“"
	@echo "ðŸ’¡ æœ¬ç•ªç”¨ã¯ 'make smart-all' ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"

# ========================================
# CIç”¨æ¤œè¨¼ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å†ç¾ç”¨ï¼‰
# ========================================

ci-verify:
	@echo "ðŸ” CIæ¤œè¨¼ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å†ç¾"
	$(PY) scripts/check_durations.py --audio_json reports/audio_peaks.json --srt $(OUT_SRT)

# ========================================
# ãƒ¯ãƒ³ã‚³ãƒžãƒ³ãƒ‰å‡¦ç†ï¼ˆãƒ•ã‚©ãƒ«ãƒ€å†…è‡ªå‹•æ¤œå‡ºï¼‰
# ========================================

# ä½¿ã„æ–¹:
# make -f Makefile_smart auto \
#   DIR=/abs/path/to/job \
#   MODEL=models/ggml-medium.bin \
#   ARCHIVE=archive \
#   MODE=move \
#   COMPRESS=0
auto:
	@mkdir -p subs reports
	@python3 scripts/oneclick.py \
		--dir "$(DIR)" \
		--model "$(MODEL)" \
		--silence_db -35 \
		--min_silence_ms 220 \
		--target_offset_ms 20 \
		--tolerance 0.050 \
		--out_prefix final_production \
		--archive_root "$(ARCHIVE)" \
		--archive_mode "$(MODE)" \
		$(if $(filter 1,$(COMPRESS)),--compress)

# ========================================
# Clean up commands
# ========================================

.PHONY: clean clean-mid clean-hard prune-archives clean-job dry-run

# ä¸­é–“ç‰©ï¼ˆå®‰å…¨ï¼‰
clean-mid:
	@echo "ðŸ§¹ remove intermediates"
	@rm -f subs/final_smart.srt subs/final_smart.vtt
	@rm -f subs/final_from_tts.srt subs/final_from_tts.vtt
	@rm -f subs/*.tmp.*
	@rm -f audio/guide_tts.wav
	@rm -f reports/whisper_tts.json
	@find . -name "*.log" -delete -o -name "*.tmp" -delete -o -name "*.bak" -delete -o -name ".DS_Store" -delete

# æˆæžœç‰©ä»¥å¤–ã‚’åºƒã‚ã«ï¼ˆæœ¬ç•ªSRT/VTTãƒ»ãƒ¢ãƒ‡ãƒ«ãƒ»archiveã¯æ®‹ã™ï¼‰
clean:
	$(MAKE) clean-mid
	@echo "ðŸ§¹ keep: subs/final_production.*, models/*, archive/*"

# ã•ã‚‰ã«å¼·ã„ï¼ˆæˆæžœç‰©ã‚‚æ¶ˆã™ï¼‰â€»å®Ÿè¡Œæ³¨æ„
clean-hard:
	@echo "âš ï¸ remove ALL outputs (final included)"
	@rm -f subs/final_production.srt subs/final_production.vtt
	$(MAKE) clean-mid

# æ—§ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®é–“å¼•ãï¼šDAYS=30 ãªã©
prune-archives:
	@[ -n "$(DAYS)" ] || (echo "Usage: make prune-archives DAYS=30"; exit 1)
	@echo "ðŸ§¯ prune archives older than $(DAYS)d"
	@find archive/success -type d -mtime +$(DAYS) -maxdepth 3 -print -exec rm -rf {} + 2>/dev/null || true
	@find archive/failed  -type d -mtime +$(DAYS) -maxdepth 3 -print -exec rm -rf {} + 2>/dev/null || true

# ä»»æ„ã‚¸ãƒ§ãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç©ºã«ï¼ˆæˆåŠŸå¾Œã®æ®‹éª¸ã‚’æŽƒé™¤ï¼‰
clean-job:
	@[ -n "$(DIR)" ] || (echo "Usage: make clean-job DIR=/path/to/job"; exit 1)
	@echo "ðŸ§½ cleaning job dir: $(DIR)"
	@find "$(DIR)" -type f -not -name ".keep" -print -delete 2>/dev/null || true

# ã¾ãšã¯æ§˜å­è¦‹ï¼ˆä½•ãŒæ¶ˆãˆã‚‹ã‹ã ã‘è¡¨ç¤ºï¼‰
dry-run:
	@echo "ðŸ”Ž would remove:"
	@ls -la subs/final_smart.* subs/final_from_tts.* subs/*.tmp.* 2>/dev/null || echo "  (none)"
	@ls -la audio/guide_tts.wav reports/whisper_tts.json 2>/dev/null || echo "  (none)"
	@echo "ðŸ”Ž find temp:"
	@find . -name "*.log" -o -name "*.tmp" -o -name "*.bak" -o -name ".DS_Store" 2>/dev/null || echo "  (none)"